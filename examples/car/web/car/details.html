<dom-module id="car-details">    
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        <h2>Tires</h2>
        <dl>
            <dt>Running:</dt>
            <dd>{{car.running}}</dd>

            <dt>Miles:</dt>
            <dd>{{car.miles}}</dd>

            <dt>Speed:</dt>
            <dd>{{car.speed}}</dd>

            <dt>Tires:</dt>
            <dd>                
            <template is="dom-repeat" items={{car.tire}}>
                    <dt>wear</dt>
                    <dd>{{item.wear}}</dd>
            </template>
            </dd>
        </dl>
        <div class="toolbar">
            <button on-q="rotateTires">Rotate Tires</button>
            <button on-click="replaceTires">Change Tires</button>
        </div>
    </template>
    <script>
        'use strict';
        class CarDetails extends Polymer.Element {

            static get is() {
                return "car-details";
            }

            static get properties() {
                return {
                    streamurl : {
                        type: String,
                        observer : '_monitor'
                    },
                    url: {
                        type: String,
                        observer : '_load'
                    },             
                    deviceid : {
                        type: String,                     
                    },
                    car : {
                        type: Object
                    }
                }
            }

            _monitor() {
                console.log("watching");
                let driver = new WebSocket(this.streamurl);
                let notifier = new notify.handler(driver);
                notifier.done = () => {
                    notifier.close();
                }
                let self = this;
                // Allow server to push important updates to UI
                notifier.on('demo', 'update', 'car', (car, err) => {
                    if (err != null) {
                        console.log(err);
                        return
                    }
                    self.car = car;
                }, this.deviceid);
            }

            _load() {
                console.log("load");
                fetch(this.url + '/data/car:').then((r) => {
                    if (r.status == 200) {
                        r.json().then((data) => {
                            this.car = data;
                        });
                    }
                }).catch(console.log);
            }

            replaceTires() {
                fetch(this.url + '/data/car:replaceTires', {
                    method : 'POST'
                }).catch(console.log);                
            }

            rotateTires() {
                fetch(this.url + '/data/car:rotateTires', {
                    method : 'POST'
                }).catch(console.log);
            }
        }
        customElements.define(CarDetails.is, CarDetails);
    </script>
</dom-module>

